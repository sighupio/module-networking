# Copyright (c) 2017-present SIGHUP s.r.l All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

[tools]
kind = "0.31.0"    
kubectl = "1.34.2"  # Latest stable for local development
kustomize = "5.6.0"
helm = "3.15.0"    
yq = "4.43.1"      
go = "1.23"        
bats = "1.11.0"    
dyff = "1.9.0"    
drone = "1.9.0"
kapp = "0.64.2"     # For GitOps-style deployments
"ubi:google/addlicense" = "v1.1.1"     
stern = "1.33.0"

# Development task definitions
[tasks.add-license]
description = "Add license headers to all files"
run = '''
echo "ðŸ“„ Adding license headers..."
addlicense -c "SIGHUP s.r.l" -y "2017-present" -v -l bsd .
echo "âœ… License headers added!"
'''

[tasks.validate-manifests]
description = "Validate all manifests can be built"
run = '''
echo "ðŸ” Validating manifest builds..."
kustomize build katalog/cilium > /dev/null && echo "  âœ… cilium"
kustomize build katalog/tigera/on-prem > /dev/null && echo "  âœ… tigera/on-prem"
kustomize build katalog/tigera/policy-only > /dev/null && echo "  âœ… tigera/policy-only"
echo "âœ… All manifests validated!"
'''

[tasks.setup]
description = "Complete development environment setup"
run = '''
echo "ðŸš€ Setting up development environment..."
mise run add-license
mise run validate-manifests
echo "âœ… Development environment ready!"
'''

[tasks.e2e-tigera]
description = "Run Tigera E2E test suite with Kind cluster (K8s 1.34)"
run = '''
#!/bin/bash
set -e
echo "ðŸš€ Running Tigera E2E workflow..."
./scripts/create-e2e-cluster.sh tigera 1.34.0
./scripts/run-tigera-tests.sh
./scripts/cleanup-e2e-cluster.sh tigera
echo "âœ… Tigera E2E workflow completed!"
'''

[tasks.e2e-cilium]
description = "Run Cilium E2E test suite with Kind cluster (K8s 1.34)"
run = '''
#!/bin/bash
set -e
echo "ðŸš€ Running Cilium E2E workflow..."
./scripts/create-e2e-cluster.sh cilium 1.34.0
./scripts/run-cilium-tests.sh
./scripts/cleanup-e2e-cluster.sh cilium
echo "âœ… Cilium E2E workflow completed!"
'''

# Individual E2E workflow components (following module-auth pattern)
[tasks.e2e-create-cluster-tigera]
description = "Create Kind cluster for Tigera E2E testing"
run = "./scripts/create-e2e-cluster.sh tigera 1.34.0"

[tasks.e2e-create-cluster-cilium]
description = "Create Kind cluster for Cilium E2E testing"
run = "./scripts/create-e2e-cluster.sh cilium 1.34.0"

[tasks.e2e-run-tests-tigera]
description = "Run Tigera E2E tests on existing cluster"
run = "./scripts/run-tigera-tests.sh"

[tasks.e2e-run-tests-cilium]
description = "Run Cilium E2E tests on existing cluster"
run = "./scripts/run-cilium-tests.sh"

[tasks.e2e-cleanup]
description = "Clean up all E2E test clusters and artifacts"
run = "./scripts/cleanup-e2e-cluster.sh"

[tasks.e2e-cleanup-tigera]
description = "Clean up Tigera E2E test cluster and artifacts"
run = "./scripts/cleanup-e2e-cluster.sh tigera"

[tasks.e2e-cleanup-cilium]  
description = "Clean up Cilium E2E test cluster and artifacts"
run = "./scripts/cleanup-e2e-cluster.sh cilium"
